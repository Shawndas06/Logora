{% extends "base.html" %}

{% block title %}Статьи - Smart ЖКХ{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Статьи</h1>
    
    {% if current_user %}
    <div class="mb-4">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createArticleModal">
            Создать статью
        </button>
    </div>
    {% endif %}

    <div class="row" id="articlesList">
        <!-- Статьи будут загружены через JavaScript -->
    </div>
</div>

<!-- Модальное окно создания статьи -->
<div class="modal fade" id="createArticleModal" tabindex="-1" aria-labelledby="createArticleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createArticleModalLabel">Создать статью</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createArticleForm">
                    <div class="mb-3">
                        <label for="title" class="form-label">Заголовок</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Содержание</label>
                        <textarea class="form-control" id="content" name="content" rows="5" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createArticle()">Создать</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования статьи -->
<div class="modal fade" id="editArticleModal" tabindex="-1" aria-labelledby="editArticleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editArticleModalLabel">Редактировать статью</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editArticleForm">
                    <input type="hidden" id="editArticleId">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">Заголовок</label>
                        <input type="text" class="form-control" id="editTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editContent" class="form-label">Содержание</label>
                        <textarea class="form-control" id="editContent" name="content" rows="5" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="updateArticle()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
async function loadArticles() {
    try {
        const response = await fetch('/articles');
        const articles = await response.json();
        const articlesList = document.getElementById('articlesList');
        articlesList.innerHTML = '';

        articles.forEach(article => {
            const articleCard = document.createElement('div');
            articleCard.className = 'col-md-6 mb-4';
            articleCard.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">${article.title}</h5>
                        <p class="card-text">${article.content}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Автор: ${article.author_id}</small>
                            ${current_user && current_user.id === article.author_id ? `
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="editArticle(${article.id})">Редактировать</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteArticle(${article.id})">Удалить</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            articlesList.appendChild(articleCard);
        });
    } catch (error) {
        console.error('Error loading articles:', error);
        alert('Ошибка при загрузке статей');
    }
}

async function createArticle() {
    const form = document.getElementById('createArticleForm');
    const formData = new FormData(form);

    try {
        const response = await fetch('/articles', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('createArticleModal'));
            modal.hide();
            form.reset();
            loadArticles();
        } else {
            const error = await response.json();
            alert(error.detail || 'Ошибка при создании статьи');
        }
    } catch (error) {
        console.error('Error creating article:', error);
        alert('Ошибка при создании статьи');
    }
}

async function editArticle(articleId) {
    try {
        const response = await fetch(`/articles/${articleId}`);
        const article = await response.json();

        document.getElementById('editArticleId').value = article.id;
        document.getElementById('editTitle').value = article.title;
        document.getElementById('editContent').value = article.content;

        const modal = new bootstrap.Modal(document.getElementById('editArticleModal'));
        modal.show();
    } catch (error) {
        console.error('Error loading article:', error);
        alert('Ошибка при загрузке статьи');
    }
}

async function updateArticle() {
    const articleId = document.getElementById('editArticleId').value;
    const form = document.getElementById('editArticleForm');
    const formData = new FormData(form);

    try {
        const response = await fetch(`/articles/${articleId}`, {
            method: 'PUT',
            body: formData
        });

        if (response.ok) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editArticleModal'));
            modal.hide();
            form.reset();
            loadArticles();
        } else {
            const error = await response.json();
            alert(error.detail || 'Ошибка при обновлении статьи');
        }
    } catch (error) {
        console.error('Error updating article:', error);
        alert('Ошибка при обновлении статьи');
    }
}

async function deleteArticle(articleId) {
    if (!confirm('Вы уверены, что хотите удалить эту статью?')) {
        return;
    }

    try {
        const response = await fetch(`/articles/${articleId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            loadArticles();
        } else {
            const error = await response.json();
            alert(error.detail || 'Ошибка при удалении статьи');
        }
    } catch (error) {
        console.error('Error deleting article:', error);
        alert('Ошибка при удалении статьи');
    }
}

// Загружаем статьи при загрузке страницы
document.addEventListener('DOMContentLoaded', loadArticles);
</script>
{% endblock %} 